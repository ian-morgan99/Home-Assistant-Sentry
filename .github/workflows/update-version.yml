name: Update Version on Release

on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get release version
        id: get_version
        run: |
          # Extract version from tag (e.g., v1.2.0 -> 1.2.0)
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
          # Get current version from config.json using jq
          if ! command -v jq &> /dev/null; then
            echo "jq not found, using grep as fallback"
            CURRENT_VERSION=$(grep -Po '(?<="version": ")[^"]*' ha_sentry/config.json)
          else
            CURRENT_VERSION=$(jq -r '.version' ha_sentry/config.json)
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Validate version increment
        run: |
          NEW_VERSION="${{ steps.get_version.outputs.version }}"
          CURRENT_VERSION="${{ steps.get_version.outputs.current_version }}"
          
          echo "Validating version update from $CURRENT_VERSION to $NEW_VERSION"
          
          # Validate version format (should be X.Y.Z)
          if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $NEW_VERSION"
            echo "Version must follow semantic versioning (X.Y.Z) where X, Y, and Z are numbers"
            exit 1
          fi
          
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid current version format: $CURRENT_VERSION"
            exit 1
          fi
          
          # Check if versions are the same
          if [ "$NEW_VERSION" == "$CURRENT_VERSION" ]; then
            echo "::error::Version $NEW_VERSION is the same as current version."
            echo "Please ensure you increment the version for each release:"
            echo "  - Patch version (x.y.Z) for bug fixes and minor changes (increment by 0.0.1)"
            echo "  - Minor version (x.Y.0) for new features or larger changes (increment by 0.1.0)"
            echo "  - Major version (X.0.0) for breaking changes (increment by 1.0.0)"
            exit 1
          fi
          
          # Parse versions (simple semver check)
          IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$NEW_VERSION"
          IFS='.' read -r CUR_MAJOR CUR_MINOR CUR_PATCH <<< "$CURRENT_VERSION"
          
          # Validate it's a proper increment
          VERSION_OK=false
          if [ "$NEW_MAJOR" -gt "$CUR_MAJOR" ]; then
            VERSION_OK=true
            echo "✓ Major version increment detected: $CURRENT_VERSION -> $NEW_VERSION"
          elif [ "$NEW_MAJOR" -eq "$CUR_MAJOR" ] && [ "$NEW_MINOR" -gt "$CUR_MINOR" ]; then
            VERSION_OK=true
            echo "✓ Minor version increment detected: $CURRENT_VERSION -> $NEW_VERSION"
          elif [ "$NEW_MAJOR" -eq "$CUR_MAJOR" ] && [ "$NEW_MINOR" -eq "$CUR_MINOR" ] && [ "$NEW_PATCH" -gt "$CUR_PATCH" ]; then
            VERSION_OK=true
            echo "✓ Patch version increment detected: $CURRENT_VERSION -> $NEW_VERSION"
          fi
          
          if [ "$VERSION_OK" = false ]; then
            echo "::error::Invalid version increment from $CURRENT_VERSION to $NEW_VERSION"
            echo "Version must be incremented following semantic versioning:"
            echo "  - Current: $CURRENT_VERSION"
            echo "  - New: $NEW_VERSION"
            echo ""
            echo "Suggested increments:"
            echo "  - Bug fixes/minor changes: $CUR_MAJOR.$CUR_MINOR.$((CUR_PATCH + 1))"
            echo "  - New features: $CUR_MAJOR.$((CUR_MINOR + 1)).0"
            echo "  - Breaking changes: $((CUR_MAJOR + 1)).0.0"
            exit 1
          fi
          
          echo "Version validation passed!"
      
      - name: Update config.json
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" ha_sentry/config.json
          echo "Updated config.json to version $VERSION"
      
      - name: Update config.yaml
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/version: \"[^\"]*\"/version: \"$VERSION\"/" ha_sentry/config.yaml
          echo "Updated config.yaml to version $VERSION"
      
      - name: Verify changes
        run: |
          echo "=== config.json ==="
          grep '"version":' ha_sentry/config.json
          echo "=== config.yaml ==="
          grep 'version:' ha_sentry/config.yaml
      
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ha_sentry/config.json ha_sentry/config.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit (version already up to date)"
          else
            NEW_VERSION="${{ steps.get_version.outputs.version }}"
            OLD_VERSION="${{ steps.get_version.outputs.current_version }}"
            git commit -m "chore: bump version from $OLD_VERSION to $NEW_VERSION" \
                       -m "Automatically updated version in config files for release $NEW_VERSION"
            git push origin main || { echo "Failed to push changes"; exit 1; }
            echo "✓ Version successfully updated and pushed to main branch"
            echo "  Previous version: $OLD_VERSION"
            echo "  New version: $NEW_VERSION"
          fi
