name: Auto-Increment Version on Main Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if commit is from bot
        id: check_bot
        run: |
          # Get the commit author
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Commit author: $COMMIT_AUTHOR"
          
          # Skip if the commit was made by the bot itself (prevent infinite loop)
          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping version increment - commit was made by github-actions bot"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with version increment"
          fi
      
      - name: Get current version and calculate new version
        if: steps.check_bot.outputs.skip != 'true'
        id: get_version
        run: |
          # Get current version from config.json using jq
          if ! command -v jq &> /dev/null; then
            echo "jq not found, using grep as fallback"
            CURRENT_VERSION=$(grep -Po '(?<="version": ")[^"]*' ha_sentry/config.json)
          else
            CURRENT_VERSION=$(jq -r '.version' ha_sentry/config.json)
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          
          # Validate version format (should be X.Y.Z or X.Y.ZZ)
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid current version format: $CURRENT_VERSION"
            echo "Version must follow semantic versioning (X.Y.Z) where X, Y, and Z are numbers"
            exit 1
          fi
          
          # Parse version and increment patch version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION (incremented patch from $CURRENT_VERSION)"
      
      - name: Update config.json
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" ha_sentry/config.json
          echo "Updated config.json to version $VERSION"
      
      - name: Update config.yaml
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/version: \"[^\"]*\"/version: \"$VERSION\"/" ha_sentry/config.yaml
          echo "Updated config.yaml to version $VERSION"
      
      - name: Verify changes
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          echo "=== config.json ==="
          grep '"version":' ha_sentry/config.json
          echo "=== config.yaml ==="
          grep 'version:' ha_sentry/config.yaml
      
      - name: Commit and push changes
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ha_sentry/config.json ha_sentry/config.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit (version already up to date)"
          else
            NEW_VERSION="${{ steps.get_version.outputs.version }}"
            OLD_VERSION="${{ steps.get_version.outputs.current_version }}"
            git commit -m "chore: auto-increment version from $OLD_VERSION to $NEW_VERSION" \
                       -m "Automatically incremented patch version in config files"
            git push origin main || { echo "Failed to push changes"; exit 1; }
            echo "âœ“ Version successfully updated and pushed to main branch"
            echo "  Previous version: $OLD_VERSION"
            echo "  New version: $NEW_VERSION"
          fi
