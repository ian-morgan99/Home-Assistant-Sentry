name: Auto-Increment Version on Main Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if commit is from bot or version-related
        id: check_bot
        run: |
          # Get the commit author and message
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          echo "Commit author: $COMMIT_AUTHOR"
          echo "Commit message: $COMMIT_MSG"
          
          # Skip if the commit was made by the bot itself (prevent infinite loop)
          # Also skip if commit message indicates version-related changes
          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping version increment - commit was made by github-actions bot"
          elif [[ "$COMMIT_MSG" == "chore: auto-increment version"* ]] || [[ "$COMMIT_MSG" == "chore: sync config.yaml version"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping version increment - commit is version-related"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with version increment"
          fi
      
      - name: Sync version between config files
        if: steps.check_bot.outputs.skip != 'true'
        id: sync_version
        run: |
          # Ensure jq is installed
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Get version from config.json using jq
          JSON_VERSION=$(jq -r '.version' ha_sentry/config.json)
          
          # Get version from config.yaml
          YAML_VERSION=$(grep '^version:' ha_sentry/config.yaml | cut -d'"' -f2)
          
          echo "json_version=$JSON_VERSION" >> $GITHUB_OUTPUT
          echo "yaml_version=$YAML_VERSION" >> $GITHUB_OUTPUT
          echo "Config.json version: $JSON_VERSION"
          echo "Config.yaml version: $YAML_VERSION"
          
          if [ "$JSON_VERSION" != "$YAML_VERSION" ]; then
            echo "synced=true" >> $GITHUB_OUTPUT
            echo "⚠️ Version mismatch detected - will sync before incrementing"
            echo "  config.json: $JSON_VERSION"
            echo "  config.yaml: $YAML_VERSION"
            echo ""
            echo "Syncing config.yaml to match config.json..."
            
            # Update config.yaml to match config.json
            sed -i "s/version: \"[^\"]*\"/version: \"$JSON_VERSION\"/" ha_sentry/config.yaml
            
            echo "✓ Synced config.yaml to $JSON_VERSION"
          else
            echo "synced=false" >> $GITHUB_OUTPUT
            echo "✓ Versions are already in sync: $JSON_VERSION"
          fi
      
      - name: Get current version and calculate new version
        if: steps.check_bot.outputs.skip != 'true'
        id: get_version
        run: |
          # Get current version from config.json using jq
          if ! command -v jq &> /dev/null; then
            echo "jq not found, using grep as fallback"
            CURRENT_VERSION=$(grep -Po '(?<="version": ")[^"]*' ha_sentry/config.json)
          else
            CURRENT_VERSION=$(jq -r '.version' ha_sentry/config.json)
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          
          # Validate version format (should be X.Y.Z where X, Y, and Z are one or more digits)
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid current version format: $CURRENT_VERSION"
            echo "Version must follow semantic versioning (X.Y.Z) where X, Y, and Z are numbers"
            exit 1
          fi
          
          # Parse version and increment patch version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Use base-10 to avoid octal interpretation of leading zeros
          # Then preserve original width (minimum 2 digits to support format like 04)
          PATCH_WIDTH=${#PATCH}
          if [ $PATCH_WIDTH -lt 2 ]; then
            PATCH_WIDTH=2
          fi
          NEW_PATCH=$((10#$PATCH + 1))
          NEW_VERSION=$(printf "%d.%d.%0${PATCH_WIDTH}d" "$MAJOR" "$MINOR" "$NEW_PATCH")
          
          # Validate generated new version
          if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Generated invalid version: $NEW_VERSION"
            exit 1
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION (incremented patch from $CURRENT_VERSION)"
      
      - name: Update config.json
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" ha_sentry/config.json
          echo "Updated config.json to version $VERSION"
      
      - name: Update config.yaml
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s/version: \"[^\"]*\"/version: \"$VERSION\"/" ha_sentry/config.yaml
          echo "Updated config.yaml to version $VERSION"
      
      - name: Update CHANGELOG.md
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Check if this version already exists in CHANGELOG.md
          if grep -q "^## $VERSION$" CHANGELOG.md; then
            echo "Version $VERSION already exists in CHANGELOG.md, skipping"
          else
            echo "Adding version $VERSION to CHANGELOG.md"
            
            # Create a temporary file with the new version entry
            # Insert after the "# Changelog" line
            awk -v version="$VERSION" '
              /^# Changelog$/ {
                print $0
                print ""
                print "## " version
                print "- Version automatically incremented"
                print "- Manual update recommended: Add detailed release notes here"
                print ""
                next
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.md.tmp
            
            mv CHANGELOG.md.tmp CHANGELOG.md
            echo "✓ Added version $VERSION to CHANGELOG.md"
          fi
      
      - name: Verify changes
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          echo "=== config.json ==="
          grep '"version":' ha_sentry/config.json
          echo "=== config.yaml ==="
          grep 'version:' ha_sentry/config.yaml
          echo "=== CHANGELOG.md (first 10 lines) ==="
          head -n 10 CHANGELOG.md
      
      - name: Commit and push changes
        if: steps.check_bot.outputs.skip != 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ha_sentry/config.json ha_sentry/config.yaml CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changes to commit (version already up to date)"
          else
            NEW_VERSION="${{ steps.get_version.outputs.version }}"
            OLD_VERSION="${{ steps.get_version.outputs.current_version }}"
            SYNCED="${{ steps.sync_version.outputs.synced }}"
            
            if [ "$SYNCED" = "true" ]; then
              git commit -m "chore: auto-increment version from $OLD_VERSION to $NEW_VERSION" \
                         -m "Synced config files, incremented patch version, and updated CHANGELOG.md"
            else
              git commit -m "chore: auto-increment version from $OLD_VERSION to $NEW_VERSION" \
                         -m "Automatically incremented patch version in config files and updated CHANGELOG.md"
            fi
            
            git push origin main || {
              echo "Failed to push changes, attempting to reset last commit"
              git reset --soft HEAD~1 || echo "Warning: failed to soft reset HEAD after push failure"
              echo "::error::Failed to push version update to main branch"
              exit 1
            }
            echo "✓ Version successfully updated and pushed to main branch"
            echo "  Previous version: $OLD_VERSION"
            echo "  New version: $NEW_VERSION"
          fi
