name: Sync Version on PR Merge

on:
  push:
    branches:
      - main
    paths:
      - 'ha_sentry/config.json'
      - 'ha_sentry/config.yaml'

jobs:
  sync-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get versions from config files
        id: get_versions
        run: |
          # Get version from config.json
          if ! command -v jq &> /dev/null; then
            echo "jq not found, using grep as fallback"
            JSON_VERSION=$(grep -Po '(?<="version": ")[^"]*' ha_sentry/config.json)
          else
            JSON_VERSION=$(jq -r '.version' ha_sentry/config.json)
          fi
          
          # Get version from config.yaml
          YAML_VERSION=$(grep -Po '(?<=version: ")[^"]*' ha_sentry/config.yaml)
          
          echo "json_version=$JSON_VERSION" >> $GITHUB_OUTPUT
          echo "yaml_version=$YAML_VERSION" >> $GITHUB_OUTPUT
          echo "Config.json version: $JSON_VERSION"
          echo "Config.yaml version: $YAML_VERSION"
      
      - name: Sync versions if different
        run: |
          JSON_VERSION="${{ steps.get_versions.outputs.json_version }}"
          YAML_VERSION="${{ steps.get_versions.outputs.yaml_version }}"
          
          if [ "$JSON_VERSION" != "$YAML_VERSION" ]; then
            echo "⚠️ Version mismatch detected!"
            echo "  config.json: $JSON_VERSION"
            echo "  config.yaml: $YAML_VERSION"
            echo ""
            echo "Syncing config.yaml to match config.json..."
            
            # Update config.yaml to match config.json
            sed -i "s/version: \"[^\"]*\"/version: \"$JSON_VERSION\"/" ha_sentry/config.yaml
            
            # Verify the change
            UPDATED_YAML_VERSION=$(grep -Po '(?<=version: ")[^"]*' ha_sentry/config.yaml)
            echo "Updated config.yaml version: $UPDATED_YAML_VERSION"
            
            # Commit and push the change
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add ha_sentry/config.yaml
            git commit -m "chore: sync config.yaml version to match config.json ($JSON_VERSION)" \
                       -m "Automatically synced version from config.json to config.yaml"
            git push origin main
            
            echo "✓ Version successfully synced to $JSON_VERSION"
          else
            echo "✓ Versions are already in sync: $JSON_VERSION"
          fi
